name: Signal Analysis CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  fft-demo-ci:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Python
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # Step 3: Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest python-dotenv numpy scipy matplotlib

      # Step 4: Clean and create folders for results
      - name: Create folders
        run: |
          rm -rf results data demo
          mkdir -p results/plots data demo

      # Step 5: Copy demo sample CSV to data folder
      - name: Prepare sample data
        run: |
          if [ ! -f data/sample_signal.csv ]; then
           cp demo/sample_signal.csv data/sample_signal.csv
          else
           echo "Sample CSV already exists"
          fi


      # Step 6: Run smoke test for FFT pipeline
      - name: Run FFT smoke test
        run: pytest tests/test_fft_pipeline.py
        env:
          PYTHONPATH: ${{ github.workspace }}

      # Step 7: Run full demo
      - name: Run demo
        run: python demo/demo_signal_pipeline.py
        env:
          PYTHONPATH: ${{ github.workspace }}

      # Step 8: Upload artifacts (metrics, plots)
      - name: Upload metrics and plots
        uses: actions/upload-artifact@v4
        with:
          name: metrics-artifacts
          path: |
            results/
            results/plots/

      # Step 9: Run demo via CLI
      - name: Run demo via CLI
        run: python -m src.signal_analysis --demo
        env:
          PYTHONPATH: ${{ github.workspace }}
